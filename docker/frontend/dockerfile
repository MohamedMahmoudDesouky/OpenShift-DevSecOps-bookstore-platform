# =========================
# Secure Multi-Stage Frontend Dockerfile (Alpine)
# =========================

# -------------------------
# BUILDER STAGE
# -------------------------
FROM nginxinc/nginx-unprivileged:1.26-alpine AS builder

USER root

# Apply CVE fixes (libpng, libxml2)
RUN apk update && \
    apk upgrade --no-cache && \
    apk add --no-cache \
        libpng=1.6.53-r0 \
        libxml2=2.12.10-r0 && \
    rm -rf /var/cache/apk/*

# Prepare directories
RUN mkdir -p /usr/share/nginx/html /var/cache/nginx /tmp

# Copy config and static assets
COPY nginx.conf /etc/nginx/nginx.conf
COPY html/ /usr/share/nginx/html/

# Optional: Validate config (if backend placeholder is used)
# RUN sed -i 's|proxy_pass http://backend:3000;|proxy_pass http://127.0.0.1:3000;|' /etc/nginx/nginx.conf \
#  && nginx -t \
#  && sed -i 's|proxy_pass http://127.0.0.1:3000;|proxy_pass http://backend:3000;|' /etc/nginx/nginx.conf

# -------------------------
# RUNTIME STAGE (Minimal Alpine)
# -------------------------
FROM nginxinc/nginx-unprivileged:1.26-alpine

USER root

# Re-apply CVE fixes in final image (to ensure no drift)
RUN apk update && \
    apk upgrade --no-cache && \
    apk add --no-cache \
        libpng=1.6.53-r0 \
        libxml2=2.12.10-r0 && \
    rm -rf /var/cache/apk/* && \
    rm -f /etc/nginx/conf.d/default.conf && \
    chown -R 101:101 /tmp /var/cache/nginx /var/run

USER 101

# Copy from builder
COPY --from=builder /etc/nginx/nginx.conf /etc/nginx/nginx.conf
COPY --from=builder /usr/share/nginx/html/ /usr/share/nginx/html/

EXPOSE 8080

CMD ["nginx", "-g", "daemon off;"]
